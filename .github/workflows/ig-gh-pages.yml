name: Build and Deploy FHIR IG to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'nlk-test/**'
      - '.github/workflows/ig-gh-pages.yml'
  pull_request:
    branches: [main]
    paths:
      - 'nlk-test/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild (clear cache)'
        required: false
        default: false
        type: boolean

# Environment variables
env:
  IG_SHORTNAME: nlk-test
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: ğŸ–¥ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.IG_SHORTNAME }}/package*.json'

      - name: ğŸ“¦ Cache FHIR packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.fhir/packages
            ${{ env.IG_SHORTNAME }}/input-cache
            ${{ env.IG_SHORTNAME }}/fsh-generated
          key: fhir-packages-${{ runner.os }}-${{ hashFiles('**/sushi-config.yaml', '**/package.json') }}
          restore-keys: |
            fhir-packages-${{ runner.os }}-

      - name: ğŸ”¥ Install FHIR packages and dependencies
        working-directory: ${{ env.IG_SHORTNAME }}
        run: |
          echo "ğŸ“¦ Installing Sushi (FSH compiler)"
          npm install -g fsh-sushi@latest
          
          echo "ğŸ“¦ Installing FHIR R4 Core package"
          npm --registry https://packages.simplifier.net install hl7.fhir.r4.core@4.0.1
          
          echo "ğŸ‡³ğŸ‡´ Installing HL7 Norway basis package"
          if [ ! -f "hl7.fhir.no.basis-2.2.0-snapshots.tgz" ]; then
            curl -L -o hl7.fhir.no.basis-2.2.0-snapshots.tgz https://raw.githubusercontent.com/HL7Norway/resources/main/snapshots/hl7.fhir.no.basis-2.2.0-snapshots.tgz
          fi
          npm install hl7.fhir.no.basis-2.2.0-snapshots.tgz
          
          echo "ğŸ—‚ï¸ Setting up FHIR package cache"
          mkdir -p ~/.fhir/packages/hl7.fhir.no.basis#2.2.0/package
          cp -r ./node_modules/hl7.fhir.no.basis/* ~/.fhir/packages/hl7.fhir.no.basis#2.2.0/package/

      - name: âš¡ Clear cache (if forced)
        if: ${{ github.event.inputs.force_rebuild == 'true' }}
        working-directory: ${{ env.IG_SHORTNAME }}
        run: |
          echo "ğŸ§¹ Force rebuild requested - clearing caches"
          rm -rf input-cache/publisher.jar
          rm -rf fsh-generated/
          rm -rf output/
          
      - name: ğŸ“¥ Download IG Publisher
        working-directory: ${{ env.IG_SHORTNAME }}
        run: |
          echo "ğŸ“¦ Downloading latest IG Publisher"
          mkdir -p input-cache
          if [ ! -f "input-cache/publisher.jar" ] || [ "${{ github.event.inputs.force_rebuild }}" == "true" ]; then
            curl -L https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar -o input-cache/publisher.jar
            echo "âœ… Downloaded publisher.jar ($(du -h input-cache/publisher.jar | cut -f1))"
          else
            echo "â™»ï¸ Using cached publisher.jar ($(du -h input-cache/publisher.jar | cut -f1))"
          fi
          
      - name: ğŸ—ï¸ Build IG with Sushi and Publisher
        working-directory: ${{ env.IG_SHORTNAME }}
        run: |
          echo "ğŸ£ Running Sushi (FSH â†’ FHIR)"
          sushi build . --out fsh-generated
          
          echo "ğŸ”¥ Running IG Publisher"
          java -Xmx4g -jar input-cache/publisher.jar -ig ig.ini -publish https://rockphotog.github.io/nlk-test/
          
      - name: ğŸ“‹ Build summary
        working-directory: ${{ env.IG_SHORTNAME }}
        run: |
          echo "âœ… Build completed successfully"
          if [ -d "output" ]; then
            echo "ğŸ“Š Output size: $(du -sh output | cut -f1)"
            echo "ğŸ“ Output files: $(find output -type f | wc -l) files"
          else
            echo "âŒ Output directory not found"
            exit 1
          fi
          
      - name: ğŸ”§ Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.IG_SHORTNAME }}/output
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          preview: ${{ github.event_name == 'pull_request' }}
          
      - name: ğŸ“‹ Deployment summary
        run: |
          echo "ğŸ‰ Successfully deployed FHIR IG to GitHub Pages"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "âœ… Deployment completed successfully"
