name: Validate FSH Files

on:
  workflow_dispatch:
    inputs:
      delete_cache:
        description: 'Delete all cache before validation'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# CONFIGURATION: The "short name" of the IG and the folder must be the same
env:
  IG_SHORTNAME: nlk-test
  # IG: ${{ vars.IG_KORTNAVN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Delete cache if requested
      if: ${{ github.event.inputs.delete_cache == 'true' }}
      run: |
        echo "üóëÔ∏è Deleting all cache directories..."
        rm -rf ~/.npm
        rm -rf ~/.fhir
        rm -rf ./node_modules
        echo "‚úÖ Cache cleared"

    - name: Cache Node.js modules
      if: ${{ github.event.inputs.delete_cache != 'true' }}
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          ${{ runner.os }}-

    - name: Show cache status
      run: |
        echo "üìä Cache status:"
        echo "Delete cache option: ${{ github.event.inputs.delete_cache }}"
        echo "NPM cache size: $(du -sh ~/.npm 2>/dev/null || echo '0B (not found)')"
        echo "FHIR cache size: $(du -sh ~/.fhir 2>/dev/null || echo '0B (not found)')"

    - name: Verify input directory structure
      run: |
        echo "üîí Security check: Ensuring only input directory is used"
        echo "Input directory structure:"
        ls -la ${{ env.IG_SHORTNAME }}/input/
        echo "FSH files in input directory:"
        find ${{ env.IG_SHORTNAME }}/input/ -name "*.fsh" -type f | head -10
        echo "‚ùå Resources directory will NOT be used for validation"
        echo "‚úÖ Only ${{ env.IG_SHORTNAME }}/input/ and subdirectories will be processed"

    - name: Install fsh-sushi
      run: npm install -g fsh-sushi

    - name: Install hl7.fhir.no.basis-2.2.0-snapshots in local cache
      run: |
        echo "NPM install fhir r4 core 4.0.1 from package registry"
        npm --registry https://packages.simplifier.net install hl7.fhir.r4.core@4.0.1
        echo "NPM install fhir no-basis220 from https://github.com/HL7Norway/resources/"
        curl -L -o hl7.fhir.no.basis-2.2.0-snapshots.tgz https://raw.githubusercontent.com/HL7Norway/resources/main/snapshots/hl7.fhir.no.basis-2.2.0-snapshots.tgz
        npm install hl7.fhir.no.basis-2.2.0-snapshots.tgz
        echo "Create .fhir packages cache directory for no-basis"
        mkdir -p $HOME/.fhir/packages/hl7.fhir.no.basis#2.2.0/package
        echo "Copy local no-basis snapshot to .fhir package cache directory"
        cp -r ./node_modules/hl7.fhir.no.basis/* $HOME/.fhir/packages/hl7.fhir.no.basis#2.2.0/package


    - name: Install fsh-validator
      run: pip install -U git+https://github.com/glichtner/fsh-validator

    - name: Validate FSH files in input directory only
      run: |
        echo "üîç Validating FSH files in input directory only..."
        echo "Working directory: ${{ env.IG_SHORTNAME }}/input/"
        echo "FSH files found:"
        find ${{ env.IG_SHORTNAME }}/input/fsh/ -name "*.fsh" -type f
        cd ${{ env.IG_SHORTNAME }}/input/fsh/
        fsh-validator --all --log-path fsh-validator.log
        echo "‚úÖ Validation complete - only input directory used"

    - name: Upload validation log
      uses: actions/upload-artifact@v4
      with:
        name: fsh-validator-log
        path: ${{ env.IG_SHORTNAME }}/input/fsh/fsh-validator.log
